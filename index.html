<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBCC Budget Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .header-left h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.25rem;
        }

        .header-left p {
            color: #6c757d;
            font-size: 0.95rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            border-color: #1e40af;
            color: #1e40af;
        }

        .btn-success {
            background: #10b981;
            color: white;
            font-size: 1rem;
            padding: 0.875rem 1.75rem;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
        }

        /* Add Expense Section */
        .add-expense-section {
            background: white;
            padding: 1.25rem 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #1e40af;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .add-expense-section-left h2 {
            color: #1e40af;
            font-size: 1.15rem;
            margin-bottom: 0.25rem;
            text-align: left;
        }

        .add-expense-section-left p {
            color: #6c757d;
            margin-bottom: 0;
            font-size: 0.9rem;
            text-align: left;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #212529;
        }

        /* Level 1 - Main Categories */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .category-item {
            padding: 1.25rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-item:hover {
            border-color: #1e40af;
            background: #f8f9ff;
        }

        .category-item.expanded {
            background: #f8f9ff;
            border-color: #1e40af;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            font-size: 1.05rem;
            color: #212529;
        }

        .category-amount {
            font-weight: 700;
            font-size: 1.15rem;
            color: #1e40af;
        }

        .category-progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 0.75rem 0;
            overflow: hidden;
        }

        .category-progress-bar {
            height: 100%;
            background: #1e40af;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .category-progress-bar.warning { background: #f59e0b; }
        .category-progress-bar.danger { background: #ef4444; }

        .category-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .variance-positive { color: #10b981; font-weight: 600; }
        .variance-negative { color: #ef4444; font-weight: 600; }

        /* Level 2 - Sub Categories */
        .sub-categories {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .sub-category-item {
            padding: 1rem;
            background: #f8f9ff;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sub-category-item:hover {
            border-color: #1e40af;
            background: #eff6ff;
        }

        .sub-category-item.expanded {
            border-color: #1e40af;
            background: #eff6ff;
        }

        .sub-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .sub-category-name {
            font-weight: 600;
            color: #1e40af;
            font-size: 0.95rem;
        }

        .sub-category-amount {
            font-weight: 600;
            color: #212529;
        }

        .sub-category-progress {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin: 0.5rem 0;
            overflow: hidden;
        }

        .sub-category-progress-bar {
            height: 100%;
            background: #1e40af;
            border-radius: 2px;
            transition: width 0.3s;
        }

        .sub-category-progress-bar.warning { background: #f59e0b; }
        .sub-category-progress-bar.danger { background: #ef4444; }

        .sub-category-stats {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* Level 3 - Individual Items */
        .level3-items {
            margin-top: 0.75rem;
            padding-left: 1rem;
            border-left: 3px solid #cbd5e1;
        }

        .item {
            padding: 0.75rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .item-name {
            font-size: 0.9rem;
            color: #495057;
            font-weight: 500;
        }

        .item-amount {
            font-weight: 600;
            color: #212529;
            font-size: 0.9rem;
        }

        .item-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .item-notes {
            font-size: 0.8rem;
            color: #6c757d;
            font-style: italic;
            margin-top: 0.25rem;
            padding-top: 0.25rem;
            border-top: 1px dashed #e9ecef;
        }

        /* Activity Log */
        .activity-log {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-left: 3px solid #1e40af;
            background: #f8f9ff;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            position: relative;
        }

        .activity-item:hover .activity-menu-trigger {
            opacity: 1;
        }

        .activity-menu-trigger {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 1rem;
            color: #6c757d;
        }

        .activity-menu-trigger:hover {
            border-color: #1e40af;
            color: #1e40af;
        }

        .activity-menu {
            position: absolute;
            top: 2.5rem;
            right: 0.75rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 120px;
        }

        .activity-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .activity-menu-item:hover {
            background: #f8f9fa;
        }

        .activity-menu-item.delete {
            color: #ef4444;
        }

        .activity-menu-item.delete:hover {
            background: #fef2f2;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .activity-user {
            font-weight: 600;
            color: #1e40af;
        }

        .activity-time {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .activity-category {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .activity-description {
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .activity-amount {
            font-weight: 700;
            color: #ef4444;
        }

        /* Budget Period Selector */
        .budget-period-selector {
            display: flex;
            gap: 0.25rem;
            align-items: center;
        }

        .period-label {
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
            margin-right: 0.25rem;
        }

        .period-btn {
            padding: 0.25rem 0.5rem;
            border: 1px solid #e9ecef;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            color: #6c757d;
        }

        .period-btn:hover {
            border-color: #1e40af;
            color: #1e40af;
        }

        .period-btn.active {
            background: #1e40af;
            color: white;
            border-color: #1e40af;
        }

        .btn-add-item {
            padding: 0.35rem 0.75rem;
            background: white;
            color: #9ca3af;
            border: 1px solid #e9ecef;
            font-size: 0.75rem;
        }

        .btn-add-item:hover {
            border-color: #1e40af;
            color: #1e40af;
        }

        /* Item notes - expanded view */
        .item-notes-full {
            font-size: 0.85rem;
            color: #495057;
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #1e40af;
        }

        .setup-budget-input {
            width: 150px;
            padding: 0.5rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-weight: 600;
            transition: border-color 0.2s;
        }

        .setup-budget-input:focus {
            outline: none;
            border-color: #1e40af;
        }

        .setup-delete-btn {
            padding: 0.4rem 0.6rem;
            background: white;
            border: 1px solid #ef4444;
            color: #ef4444;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .setup-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #212529;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #1e40af;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const MSAL_CONFIG = {
            auth: {
                clientId: '642e1f35-d45f-47d7-97fd-bb6bf64ff6e5',
                authority: 'https://login.microsoftonline.com/common',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: 'localStorage' }
        };

        function BudgetTrackerApp() {
            const [isSignedIn, setIsSignedIn] = useState(false);
            const [msalInstance, setMsalInstance] = useState(null);
            const [budgets, setBudgets] = useState([]);
            const [activities, setActivities] = useState([]);
            const [expandedCategory, setExpandedCategory] = useState(null);
            const [expandedSubCategory, setExpandedSubCategory] = useState(null);
            const [openActivityMenu, setOpenActivityMenu] = useState(null);
            const [showExpenseModal, setShowExpenseModal] = useState(false);
            const [showSetupModal, setShowSetupModal] = useState(false);
            const [showAddItemModal, setShowAddItemModal] = useState(false);
            const [showReportsModal, setShowReportsModal] = useState(false);
            const [notification, setNotification] = useState(null);
            const [currentPeriod, setCurrentPeriod] = useState('25/26');
            const [budgetPeriods] = useState(['24/25', '25/26', '26/27']);
            const [setupYearData, setSetupYearData] = useState([]);
            const [newFiscalYear, setNewFiscalYear] = useState('');
            const [excelFileId, setExcelFileId] = useState(null);
            const [isLoadingData, setIsLoadingData] = useState(false);

            const [expenseForm, setExpenseForm] = useState({
                userName: '',
                mainCategory: '',
                mainCategoryId: null,
                subCategory: '',
                subCategoryId: null,
                item: '',
                description: '',
                amount: ''
            });

            const [addItemForm, setAddItemForm] = useState({
                level: '1', // 1=main category, 2=sub-category, 3=item
                mainCategoryId: null,
                subCategoryId: null,
                code: '',
                name: '',
                budget: '',
                notes: ''
            });

            useEffect(() => {
                initializeMsal();
                checkAndSwitchFiscalYear();
                
                // Close activity menu when clicking outside
                const handleClickOutside = () => setOpenActivityMenu(null);
                document.addEventListener('click', handleClickOutside);
                return () => document.removeEventListener('click', handleClickOutside);
            }, []);

            const checkAndSwitchFiscalYear = () => {
                // Auto-switch to next fiscal year in April
                const now = new Date();
                const currentMonth = now.getMonth(); // 0 = Jan, 3 = Apr
                
                // If it's April or later, and we're still on last year's period
                if (currentMonth >= 3) { // April = month 3
                    const currentYear = now.getFullYear();
                    const nextYear = currentYear + 1;
                    const expectedPeriod = `${currentYear.toString().slice(-2)}/${nextYear.toString().slice(-2)}`;
                    
                    // Check if we need to switch
                    if (currentPeriod !== expectedPeriod) {
                        setCurrentPeriod(expectedPeriod);
                    }
                }
            };

            const initializeMsal = async () => {
                try {
                    const instance = new window.msal.PublicClientApplication(MSAL_CONFIG);
                    await instance.initialize();
                    
                    // Handle redirect response
                    await instance.handleRedirectPromise();
                    
                    setMsalInstance(instance);

                    const accounts = instance.getAllAccounts();
                    if (accounts.length > 0) {
                        console.log('User already signed in');
                        setIsSignedIn(true);
                        // Small delay before loading to ensure state is set
                        setTimeout(() => loadBudgetFromExcel(), 500);
                    } else {
                        console.log('No user signed in');
                    }
                } catch (error) {
                    console.error('MSAL initialization error:', error);
                }
            };

            const signIn = async () => {
                if (!msalInstance) {
                    alert('Authentication not initialized. Please refresh the page.');
                    return;
                }

                try {
                    // Check if interaction is already in progress
                    const inProgress = await msalInstance.handleRedirectPromise();
                    if (inProgress) {
                        console.log('Redirect in progress, waiting...');
                        return;
                    }

                    const response = await msalInstance.loginPopup({
                        scopes: ['Files.ReadWrite', 'Files.ReadWrite.All', 'Sites.ReadWrite.All', 'User.Read'],
                        prompt: 'select_account'
                    });
                    
                    console.log('Sign-in successful!', response);
                    setIsSignedIn(true);
                    loadBudgetFromExcel();
                } catch (error) {
                    console.error('Sign-in error:', error);
                    if (error.errorCode === 'interaction_in_progress') {
                        alert('Please wait a moment and try again, or refresh the page.');
                    } else {
                        alert('Sign-in failed: ' + error.message);
                    }
                }
            };

            const signOut = () => {
                msalInstance.logout();
            };

            // Microsoft Graph API Helper Functions
            const getAccessToken = async () => {
                try {
                    const accounts = msalInstance.getAllAccounts();
                    if (accounts.length === 0) return null;
                    
                    const response = await msalInstance.acquireTokenSilent({
                        scopes: ['Files.ReadWrite', 'Files.ReadWrite.All', 'Sites.ReadWrite.All'],
                        account: accounts[0]
                    });
                    return response.accessToken;
                } catch (error) {
                    console.error('Token error:', error);
                    return null;
                }
            };

            const findExcelFile = async (fileName) => {
                const token = await getAccessToken();
                if (!token) {
                    console.error('No access token available');
                    return null;
                }

                try {
                    // Try OneDrive for Business path first (Documents library)
                    console.log('Searching for file:', fileName);
                    console.log('Trying path: /Documents/' + fileName);
                    
                    let response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root:/Documents/${fileName}`,
                        {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }
                    );
                    
                    console.log('Documents path response status:', response.status);
                    
                    if (response.ok) {
                        const file = await response.json();
                        console.log('File found in Documents! ID:', file.id);
                        return file.id;
                    } else {
                        const errorText = await response.text();
                        console.error('Documents path error:', errorText);
                    }

                    // Fallback to personal OneDrive root
                    console.log('Trying fallback path: /' + fileName);
                    response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root:/${fileName}`,
                        {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }
                    );
                    
                    console.log('Root path response status:', response.status);
                    
                    if (response.ok) {
                        const file = await response.json();
                        console.log('File found in root! ID:', file.id);
                        return file.id;
                    } else {
                        const errorText = await response.text();
                        console.error('Root path error:', errorText);
                    }

                    // Try listing all files to see what's available
                    console.log('Listing all files in drive...');
                    const listResponse = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root/children`,
                        {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }
                    );
                    
                    if (listResponse.ok) {
                        const listData = await listResponse.json();
                        console.log('Files in root:', listData.value.map(f => f.name));
                    }

                    return null;
                } catch (error) {
                    console.error('File search error:', error);
                    return null;
                }
            };

            const readExcelData = async (fileId, sheetName) => {
                const token = await getAccessToken();
                if (!token) return null;

                try {
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets/${sheetName}/usedRange`,
                        {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        return data.values;
                    }
                    return null;
                } catch (error) {
                    console.error('Excel read error:', error);
                    return null;
                }
            };

            const writeExcelCell = async (fileId, sheetName, cell, value) => {
                const token = await getAccessToken();
                if (!token) return false;

                try {
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets/${sheetName}/range(address='${cell}')`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ values: [[value]] })
                        }
                    );
                    return response.ok;
                } catch (error) {
                    console.error('Excel write error:', error);
                    return false;
                }
            };

            const parseExcelToHierarchy = (excelData) => {
                if (!excelData || excelData.length < 2) return [];

                const budgets = [];
                let currentMain = null;
                let currentSub = null;
                let mainId = 0;
                let subId = 0;
                let itemId = 0;

                // Skip header row
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    const code = row[0];
                    const description = row[1];
                    const budget = parseFloat(row[2]) || 0;
                    const actualSpend = parseFloat(row[4]) || 0;
                    const notes = row[6] || '';

                    if (!description) continue; // Skip empty rows

                    // Check if it's a main category (starts with 'A')
                    if (code && typeof code === 'string' && code.startsWith('A')) {
                        currentMain = {
                            id: ++mainId,
                            code: code,
                            name: description,
                            totalAmount: budget,
                            spentAmount: actualSpend,
                            subCategories: [],
                            excelRow: i + 1
                        };
                        budgets.push(currentMain);
                        currentSub = null;
                    }
                    // Check if it's a sub-category (has numeric code)
                    else if (code && !isNaN(code)) {
                        if (currentMain) {
                            currentSub = {
                                id: ++subId,
                                code: code.toString(),
                                name: description,
                                totalAmount: budget,
                                spentAmount: actualSpend,
                                items: [],
                                excelRow: i + 1
                            };
                            currentMain.subCategories.push(currentSub);
                        }
                    }
                    // It's an individual item (no code)
                    else if (!code && currentSub) {
                        currentSub.items.push({
                            id: ++itemId,
                            name: description,
                            budget: budget,
                            spent: actualSpend,
                            notes: notes,
                            excelRow: i + 1
                        });
                    }
                    // Item directly under main category (no sub-category)
                    else if (!code && currentMain && !currentSub) {
                        // For categories like Training that have items but no sub-categories
                        if (!currentMain.items) {
                            currentMain.items = [];
                        }
                        currentMain.items.push({
                            id: ++itemId,
                            name: description,
                            budget: budget,
                            spent: actualSpend,
                            notes: notes,
                            excelRow: i + 1
                        });
                    }
                }

                return budgets;
            };

            const loadBudgetFromExcel = async () => {
                setIsLoadingData(true);
                const fileName = `DBCC-Budget-${currentPeriod.replace('/', '-')}.xlsx`;
                
                try {
                    // Find the Excel file
                    const fileId = await findExcelFile(fileName);
                    if (!fileId) {
                        showNotification(`File not found: ${fileName}. Using sample data.`);
                        loadSampleData();
                        setIsLoadingData(false);
                        return;
                    }

                    setExcelFileId(fileId);

                    // Read Excel data
                    const sheetName = `${currentPeriod} budget`;
                    const excelData = await readExcelData(fileId, sheetName);
                    
                    if (!excelData) {
                        showNotification('Could not read Excel data. Using sample data.');
                        loadSampleData();
                        setIsLoadingData(false);
                        return;
                    }

                    // Parse into hierarchy
                    const hierarchy = parseExcelToHierarchy(excelData);
                    setBudgets(hierarchy);
                    showNotification(`✅ Loaded budget from ${fileName}`);
                    
                } catch (error) {
                    console.error('Load error:', error);
                    showNotification('Error loading from Excel. Using sample data.');
                    loadSampleData();
                } finally {
                    setIsLoadingData(false);
                }
            };

            const loadSampleData = () => {
                // Load budget data with 3-level hierarchy
                setBudgets([
                    {
                        id: 1,
                        code: 'A14',
                        name: 'Staff Costs - Indirect',
                        totalAmount: 3297995,
                        spentAmount: 84785,
                        subCategories: [
                            {
                                id: 1,
                                code: '2127',
                                name: 'BOCRA Social Activities',
                                totalAmount: 150000,
                                spentAmount: 80785,
                                items: []
                            },
                            {
                                id: 2,
                                code: '2128',
                                name: 'Staff uniform',
                                totalAmount: 1684537,
                                spentAmount: 0,
                                items: []
                            },
                            {
                                id: 3,
                                code: '2132',
                                name: 'Subscriptions to professional memberships',
                                totalAmount: 13308,
                                spentAmount: 3200,
                                items: []
                            }
                        ]
                    },
                    {
                        id: 2,
                        code: 'A15',
                        name: 'Training',
                        totalAmount: 469189,
                        spentAmount: 124318.59,
                        subCategories: []
                    },
                    {
                        id: 3,
                        code: 'A16',
                        name: 'Operating costs',
                        totalAmount: 16160398,
                        spentAmount: 1185701.66,
                        subCategories: [
                            {
                                id: 1,
                                code: '2134',
                                name: 'Entertainment',
                                totalAmount: 20000,
                                spentAmount: 0,
                                items: []
                            },
                            {
                                id: 2,
                                code: '3150',
                                name: 'Consultancies',
                                totalAmount: 4604133,
                                spentAmount: 689527.94,
                                items: [
                                    { 
                                        id: 1,
                                        name: 'Consumer/operator Perception Survey', 
                                        budget: 380133, 
                                        spent: 444708.3,
                                        notes: '64,575 to be sourced from the BOCRA Contingency'
                                    },
                                    { 
                                        id: 2,
                                        name: 'Outsourcing PR Events', 
                                        budget: 2000000, 
                                        spent: 0,
                                        notes: ''
                                    },
                                    { 
                                        id: 3,
                                        name: 'Elections Monitoring and Training of Broadcasters', 
                                        budget: 500000, 
                                        spent: 15250,
                                        notes: 'costs for Elections code of conduct training for Politicians'
                                    },
                                    { 
                                        id: 4,
                                        name: 'Consumer Coverage FM Monitoring', 
                                        budget: 224000, 
                                        spent: 28140,
                                        notes: ''
                                    },
                                    { 
                                        id: 5,
                                        name: 'Maintenance of the Broadcast Monitoring System', 
                                        budget: 1500000, 
                                        spent: 201419.64,
                                        notes: ''
                                    }
                                ]
                            },
                            {
                                id: 3,
                                code: '3160',
                                name: 'Conferences hosted by BOCRA',
                                totalAmount: 2124172,
                                spentAmount: 424123.36,
                                items: [
                                    { 
                                        id: 1,
                                        name: 'IIC', 
                                        budget: 250000, 
                                        spent: 118620,
                                        notes: 'Dato Seiko, Mmokolodi and Interpretation'
                                    },
                                    { 
                                        id: 2,
                                        name: 'National Broadcasting Conference', 
                                        budget: 340000, 
                                        spent: 305503.36,
                                        notes: 'registration booth, videography, evaluation meeting lunch'
                                    },
                                    { 
                                        id: 3,
                                        name: 'Benchmarking Exercises', 
                                        budget: 66000, 
                                        spent: 0,
                                        notes: 'NAM, MOM, LCA'
                                    },
                                    { 
                                        id: 4,
                                        name: 'Cyber Security Workshops', 
                                        budget: 176000, 
                                        spent: 0,
                                        notes: 'We can move the media training to here'
                                    },
                                    { 
                                        id: 5,
                                        name: 'Annual Cyber Drill', 
                                        budget: 176000, 
                                        spent: 0,
                                        notes: ''
                                    },
                                    { 
                                        id: 6,
                                        name: 'IPv6 Workshops', 
                                        budget: 176000, 
                                        spent: 0,
                                        notes: ''
                                    },
                                    { 
                                        id: 7,
                                        name: 'WTSA Workshops', 
                                        budget: 100000, 
                                        spent: 0,
                                        notes: 'Held 7 May'
                                    },
                                    { 
                                        id: 8,
                                        name: 'CRASA, EXCO and Committees', 
                                        budget: 550000, 
                                        spent: 0,
                                        notes: ''
                                    }
                                ]
                            },
                            {
                                id: 4,
                                code: '3170',
                                name: 'Conferences',
                                totalAmount: 525673.55,
                                spentAmount: 0,
                                items: [
                                    { id: 1, name: 'IIC', budget: 126052.66, spent: 0, notes: '' },
                                    { id: 2, name: 'Next TV Series', budget: 99142.86, spent: 0, notes: 'Used by the Certificate in Corporate Communication' },
                                    { id: 3, name: 'Africast', budget: 61761.54, spent: 0, notes: '' },
                                    { id: 4, name: 'International Association of Media & Comms Research', budget: 25000, spent: 0, notes: '' }
                                ]
                            }
                        ]
                    }
                ]);

                setActivities([
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        userName: 'Keotshepile M.',
                        mainCategory: 'A16 - Operating costs',
                        subCategory: '3150 - Consultancies',
                        item: 'Consumer/operator Perception Survey',
                        amount: 444708.30
                    },
                    {
                        id: 2,
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        userName: 'Mothusi M.',
                        mainCategory: 'A16 - Operating costs',
                        subCategory: '3160 - Conferences hosted by BOCRA',
                        item: 'IIC',
                        amount: 118620
                    }
                ]);
            };

            const formatCurrency = (amount) => {
                return `P ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatTime = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours}h ago`;
                return date.toLocaleDateString();
            };

            const calculateStats = () => {
                const totalBudget = budgets.reduce((sum, b) => sum + b.totalAmount, 0);
                const totalSpent = budgets.reduce((sum, b) => sum + b.spentAmount, 0);
                const totalRemaining = totalBudget - totalSpent;
                return { totalBudget, totalSpent, totalRemaining };
            };

            const getProgressColor = (percentage) => {
                if (percentage >= 90) return 'danger';
                if (percentage >= 75) return 'warning';
                return '';
            };

            const showNotification = (message) => {
                setNotification(message);
                setTimeout(() => setNotification(null), 3000);
            };

            const handleAddExpense = async (e) => {
                e.preventDefault();
                
                if (!excelFileId) {
                    showNotification('⚠️ Excel file not connected. Please reload.');
                    return;
                }

                // Find the Excel row for this item
                const mainCat = budgets.find(b => b.id === expenseForm.mainCategoryId);
                if (!mainCat) return;

                let excelRow = null;
                let itemName = expenseForm.item;

                // Find the specific item
                if (expenseForm.subCategoryId) {
                    const subCat = mainCat.subCategories.find(s => s.id === expenseForm.subCategoryId);
                    if (subCat && subCat.items) {
                        const item = subCat.items.find(i => i.name === expenseForm.item);
                        if (item) excelRow = item.excelRow;
                    }
                } else if (mainCat.items) {
                    const item = mainCat.items.find(i => i.name === expenseForm.item);
                    if (item) excelRow = item.excelRow;
                }

                if (!excelRow) {
                    showNotification('⚠️ Could not find item in Excel.');
                    return;
                }

                // Get current actual spend
                const currentSpend = await getCurrentActualSpend(excelRow);
                const newTotal = currentSpend + parseFloat(expenseForm.amount);

                // Write to Excel
                const sheetName = `${currentPeriod} budget`;
                const success = await writeExcelCell(
                    excelFileId, 
                    sheetName, 
                    `E${excelRow}`, 
                    newTotal
                );

                if (success) {
                    // Create activity log
                    const newActivity = {
                        id: activities.length + 1,
                        timestamp: new Date().toISOString(),
                        userName: expenseForm.userName,
                        mainCategory: expenseForm.mainCategory,
                        subCategory: expenseForm.subCategory,
                        item: expenseForm.item,
                        amount: parseFloat(expenseForm.amount),
                        type: 'expense'
                    };

                    setActivities([newActivity, ...activities]);
                    showNotification('✅ Expense saved to Excel!');
                    
                    // Reload data to reflect changes
                    setTimeout(() => loadBudgetFromExcel(), 1000);
                } else {
                    showNotification('❌ Failed to save to Excel');
                }

                setShowExpenseModal(false);
                setExpenseForm({
                    userName: '',
                    mainCategory: '',
                    mainCategoryId: null,
                    subCategory: '',
                    subCategoryId: null,
                    item: '',
                    description: '',
                    amount: ''
                });
            };

            const getCurrentActualSpend = async (row) => {
                const token = await getAccessToken();
                if (!token) return 0;

                try {
                    const sheetName = `${currentPeriod} budget`;
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${sheetName}/range(address='E${row}')`,
                        {
                            headers: { 'Authorization': `Bearer ${token}` }
                        }
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        return parseFloat(data.values[0][0]) || 0;
                    }
                    return 0;
                } catch (error) {
                    console.error('Read current spend error:', error);
                    return 0;
                }
            };

            const createNewExcelFile = async (fileName, sheetName, budgetData) => {
                const token = await getAccessToken();
                if (!token) return null;

                try {
                    // Create new workbook in Documents folder (OneDrive for Business)
                    let createResponse = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/root:/Documents/${fileName}:/content`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                            },
                            body: new Blob([], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
                        }
                    );

                    // Fallback to root if Documents doesn't work
                    if (!createResponse.ok) {
                        createResponse = await fetch(
                            `https://graph.microsoft.com/v1.0/me/drive/root:/${fileName}:/content`,
                            {
                                method: 'PUT',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                                },
                                body: new Blob([], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' })
                            }
                        );
                    }

                    if (!createResponse.ok) return null;
                    const fileData = await createResponse.json();
                    const newFileId = fileData.id;

                    // Add worksheet with proper name
                    await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${newFileId}/workbook/worksheets`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ name: sheetName })
                        }
                    );

                    // Write headers and data
                    await writeExcelBulkData(newFileId, sheetName, budgetData);

                    return newFileId;
                } catch (error) {
                    console.error('Create file error:', error);
                    return null;
                }
            };

            const writeExcelBulkData = async (fileId, sheetName, budgetData) => {
                const token = await getAccessToken();
                if (!token) return false;

                try {
                    // Prepare data array
                    const rows = [
                        ['Code', 'Description', `Budget ${budgetData.fiscalYear} FY`, 'Amount Approved on memo', 'Actual Spend', 'Variance', 'Notes']
                    ];

                    // Build rows from budget hierarchy
                    for (const mainCat of budgetData.categories) {
                        // Main category row
                        rows.push([
                            mainCat.code,
                            mainCat.name,
                            mainCat.totalAmount,
                            '',
                            '',
                            '',
                            ''
                        ]);

                        // Sub-categories and items
                        if (mainCat.subCategories) {
                            for (const subCat of mainCat.subCategories) {
                                rows.push([
                                    subCat.code,
                                    subCat.name,
                                    subCat.totalAmount,
                                    '',
                                    '',
                                    `=C${rows.length + 1}-E${rows.length + 1}`,
                                    ''
                                ]);

                                if (subCat.items) {
                                    for (const item of subCat.items) {
                                        rows.push([
                                            '',
                                            item.name,
                                            item.budget,
                                            '',
                                            '',
                                            `=C${rows.length + 1}-E${rows.length + 1}`,
                                            item.notes || ''
                                        ]);
                                    }
                                }
                            }
                        }

                        // Items directly under main category
                        if (mainCat.items) {
                            for (const item of mainCat.items) {
                                rows.push([
                                    '',
                                    item.name,
                                    item.budget,
                                    '',
                                    '',
                                    `=C${rows.length + 1}-E${rows.length + 1}`,
                                    item.notes || ''
                                ]);
                            }
                        }
                    }

                    // Write all data at once
                    const rangeAddress = `A1:G${rows.length}`;
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets/${sheetName}/range(address='${rangeAddress}')`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ values: rows })
                        }
                    );

                    return response.ok;
                } catch (error) {
                    console.error('Bulk write error:', error);
                    return false;
                }
            };

            const insertExcelRow = async (fileId, sheetName, afterRow, rowData) => {
                const token = await getAccessToken();
                if (!token) return false;

                try {
                    // Insert row
                    await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets/${sheetName}/range(address='${afterRow}:${afterRow}')/insert`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ shift: 'Down' })
                        }
                    );

                    // Write data to new row
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets/${sheetName}/range(address='A${afterRow}:G${afterRow}')`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ values: [rowData] })
                        }
                    );

                    return response.ok;
                } catch (error) {
                    console.error('Insert row error:', error);
                    return false;
                }
            };

            const deleteExcelRow = async (fileId, sheetName, rowNumber) => {
                const token = await getAccessToken();
                if (!token) return false;

                try {
                    const response = await fetch(
                        `https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/workbook/worksheets/${sheetName}/range(address='${rowNumber}:${rowNumber}')/delete`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ shift: 'Up' })
                        }
                    );

                    return response.ok;
                } catch (error) {
                    console.error('Delete row error:', error);
                    return false;
                }
            };

            const handleDeleteRecord = (activityId) => {
                const activity = activities.find(a => a.id === activityId);
                if (!activity) return;

                if (confirm(`Are you sure you want to delete this ${formatCurrency(activity.amount)} expense?`)) {
                    // Create deletion log entry
                    const deletionLog = {
                        id: activities.length + 1,
                        timestamp: new Date().toISOString(),
                        userName: 'System',
                        mainCategory: activity.mainCategory,
                        subCategory: activity.subCategory,
                        item: activity.item,
                        amount: activity.amount,
                        type: 'deletion',
                        deletedBy: 'Current User' // In real app, get from MSAL
                    };

                    // Remove the activity and add deletion log
                    setActivities([deletionLog, ...activities.filter(a => a.id !== activityId)]);
                    showNotification('Record deleted and logged');
                }
            };

            const handleAddBudgetItem = async (e) => {
                e.preventDefault();
                
                if (!excelFileId) {
                    showNotification('⚠️ Excel file not connected');
                    return;
                }

                const sheetName = `${currentPeriod} budget`;
                let insertAfterRow = 2; // Default to after header
                const level = parseInt(addItemForm.level);

                // Determine where to insert based on level
                if (level === 1) {
                    // Main category - add at end
                    insertAfterRow = budgets[budgets.length - 1]?.excelRow || 2;
                } else if (level === 2) {
                    // Sub-category - add after parent main category's last sub
                    const mainCat = budgets.find(b => b.id === addItemForm.mainCategoryId);
                    if (mainCat && mainCat.subCategories && mainCat.subCategories.length > 0) {
                        const lastSub = mainCat.subCategories[mainCat.subCategories.length - 1];
                        insertAfterRow = lastSub.excelRow;
                    } else if (mainCat) {
                        insertAfterRow = mainCat.excelRow;
                    }
                } else if (level === 3) {
                    // Item - add after parent sub-category's last item
                    const mainCat = budgets.find(b => b.id === addItemForm.mainCategoryId);
                    if (mainCat) {
                        const subCat = mainCat.subCategories?.find(s => s.id === addItemForm.subCategoryId);
                        if (subCat && subCat.items && subCat.items.length > 0) {
                            const lastItem = subCat.items[subCat.items.length - 1];
                            insertAfterRow = lastItem.excelRow;
                        } else if (subCat) {
                            insertAfterRow = subCat.excelRow;
                        }
                    }
                }

                // Prepare row data
                const rowData = [
                    level === 3 ? '' : addItemForm.code, // Code (blank for items)
                    addItemForm.name,
                    parseFloat(addItemForm.budget) || 0,
                    '',
                    '',
                    `=C${insertAfterRow + 1}-E${insertAfterRow + 1}`, // Variance formula
                    addItemForm.notes || ''
                ];

                setIsLoadingData(true);
                
                try {
                    const success = await insertExcelRow(excelFileId, sheetName, insertAfterRow + 1, rowData);
                    
                    if (success) {
                        showNotification('✅ Budget item added to Excel!');
                        setTimeout(() => loadBudgetFromExcel(), 1000);
                    } else {
                        showNotification('❌ Failed to add item to Excel');
                    }
                } catch (error) {
                    showNotification('❌ Error adding item');
                    console.error(error);
                } finally {
                    setIsLoadingData(false);
                }

                setShowAddItemModal(false);
                setAddItemForm({
                    level: '1',
                    mainCategoryId: null,
                    subCategoryId: null,
                    code: '',
                    name: '',
                    budget: '',
                    notes: ''
                });
            };

            const openSetupNewYear = () => {
                // Deep clone current budget data to prefill the setup
                const clonedData = JSON.parse(JSON.stringify(budgets));
                setSetupYearData(clonedData);
                setNewFiscalYear('26/27'); // Default next year
                setShowSetupModal(true);
            };

            const handleSetupYearSubmit = async () => {
                // Check if creating new year or editing current
                const isNewYear = newFiscalYear !== currentPeriod;
                const fileName = `DBCC-Budget-${newFiscalYear.replace('/', '-')}.xlsx`;
                const sheetName = `${newFiscalYear} budget`;

                if (isNewYear) {
                    // Creating new year - create new Excel file
                    setIsLoadingData(true);
                    
                    try {
                        const budgetData = {
                            fiscalYear: newFiscalYear,
                            categories: setupYearData
                        };

                        const newFileId = await createNewExcelFile(fileName, sheetName, budgetData);
                        
                        if (newFileId) {
                            showNotification(`✅ Created ${fileName} successfully!`);
                            setCurrentPeriod(newFiscalYear);
                            setTimeout(() => loadBudgetFromExcel(), 2000);
                        } else {
                            showNotification('❌ Failed to create new Excel file');
                        }
                    } catch (error) {
                        showNotification('❌ Error creating new year');
                        console.error(error);
                    } finally {
                        setIsLoadingData(false);
                    }
                    
                    setShowSetupModal(false);
                } else {
                    // Editing current year - update existing file
                    if (!excelFileId) {
                        showNotification('⚠️ Excel file not connected');
                        return;
                    }

                    setIsLoadingData(true);
                    
                    try {
                        // Update budget amounts in Column C
                        for (const mainCat of setupYearData) {
                            if (mainCat.excelRow) {
                                await writeExcelCell(excelFileId, sheetName, `C${mainCat.excelRow}`, mainCat.totalAmount);
                            }
                            
                            if (mainCat.subCategories) {
                                for (const subCat of mainCat.subCategories) {
                                    if (subCat.excelRow) {
                                        await writeExcelCell(excelFileId, sheetName, `C${subCat.excelRow}`, subCat.totalAmount);
                                    }
                                    
                                    if (subCat.items) {
                                        for (const item of subCat.items) {
                                            if (item.excelRow) {
                                                await writeExcelCell(excelFileId, sheetName, `C${item.excelRow}`, item.budget);
                                            }
                                        }
                                    }
                                }
                            }
                            
                            if (mainCat.items) {
                                for (const item of mainCat.items) {
                                    if (item.excelRow) {
                                        await writeExcelCell(excelFileId, sheetName, `C${item.excelRow}`, item.budget);
                                    }
                                }
                            }
                        }

                        showNotification(`✅ Updated budget for FY ${newFiscalYear}!`);
                        setTimeout(() => loadBudgetFromExcel(), 1000);
                    } catch (error) {
                        showNotification('❌ Error updating Excel');
                        console.error(error);
                    } finally {
                        setIsLoadingData(false);
                    }
                    
                    setShowSetupModal(false);
                }
            };

            const updateSetupBudgetAmount = (mainId, subId, itemId, newAmount) => {
                const updated = [...setupYearData];
                const mainCat = updated.find(m => m.id === mainId);
                if (!mainCat) return;

                if (subId === null) {
                    // Update main category
                    mainCat.totalAmount = parseFloat(newAmount) || 0;
                } else {
                    const subCat = mainCat.subCategories.find(s => s.id === subId);
                    if (!subCat) return;

                    if (itemId === null) {
                        // Update sub-category
                        subCat.totalAmount = parseFloat(newAmount) || 0;
                    } else {
                        // Update item
                        const item = subCat.items.find(i => i.id === itemId);
                        if (item) {
                            item.budget = parseFloat(newAmount) || 0;
                        }
                        
                        // Auto-calculate sub-category total from items
                        if (subCat.items.length > 0) {
                            subCat.totalAmount = subCat.items.reduce((sum, item) => sum + (item.budget || 0), 0);
                        }
                    }
                    
                    // Auto-calculate main category total from sub-categories
                    if (mainCat.subCategories.length > 0) {
                        mainCat.totalAmount = mainCat.subCategories.reduce((sum, sub) => sum + (sub.totalAmount || 0), 0);
                    }
                }
                setSetupYearData(updated);
            };

            const deleteSetupItem = async (mainId, subId, itemId) => {
                const updated = [...setupYearData];
                const mainCat = updated.find(m => m.id === mainId);
                if (!mainCat) return;

                let excelRow = null;

                if (subId === null) {
                    // Delete main category
                    excelRow = mainCat.excelRow;
                    const filtered = updated.filter(m => m.id !== mainId);
                    setSetupYearData(filtered);
                } else if (itemId === null) {
                    // Delete sub-category
                    const subCat = mainCat.subCategories?.find(s => s.id === subId);
                    if (subCat) excelRow = subCat.excelRow;
                    mainCat.subCategories = mainCat.subCategories.filter(s => s.id !== subId);
                    setSetupYearData(updated);
                } else {
                    // Delete item
                    const subCat = mainCat.subCategories?.find(s => s.id === subId);
                    if (subCat) {
                        const item = subCat.items?.find(i => i.id === itemId);
                        if (item) excelRow = item.excelRow;
                        subCat.items = subCat.items.filter(i => i.id !== itemId);
                        setSetupYearData(updated);
                    }
                }

                // Delete from Excel if we're editing current year
                if (excelRow && excelFileId && newFiscalYear === currentPeriod) {
                    const sheetName = `${currentPeriod} budget`;
                    await deleteExcelRow(excelFileId, sheetName, excelRow);
                    showNotification('✅ Deleted from Excel');
                }
            };

            const generateQuarterlyReport = (quarter) => {
                const stats = calculateStats();
                const date = new Date().toLocaleDateString();
                
                let report = `
═══════════════════════════════════════════════════════════════════════════════
                    DBCC BUDGET TRACKER - ${quarter} REPORT
                         Fiscal Year ${currentPeriod}
                         Generated: ${date}
═══════════════════════════════════════════════════════════════════════════════

EXECUTIVE SUMMARY
───────────────────────────────────────────────────────────────────────────────
Total Budget:        ${formatCurrency(stats.totalBudget)}
Total Spent:         ${formatCurrency(stats.totalSpent)}
Remaining:           ${formatCurrency(stats.totalRemaining)}
Utilization:         ${((stats.totalSpent / stats.totalBudget) * 100).toFixed(2)}%

═══════════════════════════════════════════════════════════════════════════════
DETAILED BREAKDOWN BY CATEGORY
═══════════════════════════════════════════════════════════════════════════════

`;

                budgets.forEach(mainCat => {
                    const variance = mainCat.totalAmount - mainCat.spentAmount;
                    const percentage = (mainCat.spentAmount / mainCat.totalAmount) * 100;
                    
                    report += `
${mainCat.code} - ${mainCat.name}
───────────────────────────────────────────────────────────────────────────────
Budget:              ${formatCurrency(mainCat.totalAmount)}
Spent:               ${formatCurrency(mainCat.spentAmount)}
Remaining:           ${formatCurrency(variance)}
Utilization:         ${percentage.toFixed(2)}%

`;

                    if (mainCat.subCategories && mainCat.subCategories.length > 0) {
                        report += `  Sub-Categories:\n`;
                        mainCat.subCategories.forEach(subCat => {
                            const subVariance = subCat.totalAmount - subCat.spentAmount;
                            const subPercentage = (subCat.spentAmount / subCat.totalAmount) * 100;
                            
                            report += `
    ${subCat.code} - ${subCat.name}
    Budget: ${formatCurrency(subCat.totalAmount)} | Spent: ${formatCurrency(subCat.spentAmount)} | Remaining: ${formatCurrency(subVariance)} | ${subPercentage.toFixed(1)}%
`;

                            if (subCat.items && subCat.items.length > 0) {
                                subCat.items.forEach(item => {
                                    const itemVariance = item.budget - item.spent;
                                    const itemPercentage = (item.spent / item.budget) * 100;
                                    
                                    report += `        • ${item.name}
          Budget: ${formatCurrency(item.budget)} | Spent: ${formatCurrency(item.spent)} | Remaining: ${formatCurrency(itemVariance)} | ${itemPercentage.toFixed(1)}%
`;
                                    if (item.notes) {
                                        report += `          Notes: ${item.notes}\n`;
                                    }
                                });
                            }
                        });
                    }

                    if (mainCat.items && mainCat.items.length > 0) {
                        report += `  Items:\n`;
                        mainCat.items.forEach(item => {
                            const itemVariance = item.budget - item.spent;
                            const itemPercentage = (item.spent / item.budget) * 100;
                            
                            report += `    • ${item.name}
      Budget: ${formatCurrency(item.budget)} | Spent: ${formatCurrency(item.spent)} | Remaining: ${formatCurrency(itemVariance)} | ${itemPercentage.toFixed(1)}%
`;
                            if (item.notes) {
                                report += `      Notes: ${item.notes}\n`;
                            }
                        });
                    }

                    report += `\n`;
                });

                report += `
═══════════════════════════════════════════════════════════════════════════════
RECENT ACTIVITY LOG
═══════════════════════════════════════════════════════════════════════════════

`;

                activities.slice(0, 20).forEach(activity => {
                    const actDate = new Date(activity.timestamp).toLocaleDateString();
                    const actTime = new Date(activity.timestamp).toLocaleTimeString();
                    
                    if (activity.type === 'deletion') {
                        report += `[${actDate} ${actTime}] DELETED by ${activity.deletedBy}\n`;
                        report += `  ${activity.mainCategory} → ${activity.subCategory} → ${activity.item}\n`;
                        report += `  Amount: ${formatCurrency(activity.amount)}\n\n`;
                    } else {
                        report += `[${actDate} ${actTime}] ${activity.userName}\n`;
                        report += `  ${activity.mainCategory} → ${activity.subCategory} → ${activity.item}\n`;
                        report += `  Amount: ${formatCurrency(activity.amount)}\n\n`;
                    }
                });

                report += `
═══════════════════════════════════════════════════════════════════════════════
                              END OF REPORT
═══════════════════════════════════════════════════════════════════════════════
`;

                // Download report
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `DBCC_Budget_${currentPeriod}_${quarter}_Report.txt`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification(`✅ ${quarter} Report downloaded!`);
            };

            const getSubCategoriesForMain = () => {
                if (!expenseForm.mainCategoryId) return [];
                const mainCat = budgets.find(b => b.id === expenseForm.mainCategoryId);
                return mainCat ? mainCat.subCategories : [];
            };

            const getItemsForSubCategory = () => {
                if (!expenseForm.mainCategoryId || !expenseForm.subCategoryId) return [];
                const mainCat = budgets.find(b => b.id === expenseForm.mainCategoryId);
                if (!mainCat) return [];
                const subCat = mainCat.subCategories.find(s => s.id === expenseForm.subCategoryId);
                return subCat ? subCat.items : [];
            };

            if (!isSignedIn) {
                return (
                    <div className="container">
                        <div className="header">
                            <div className="header-left">
                                <h1>DBCC Budget Tracker</h1>
                                <p>Budget monitoring and expense tracking system</p>
                            </div>
                        </div>
                        <div className="card" style={{ textAlign: 'center', padding: '3rem' }}>
                            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>🔐</div>
                            <h2 style={{ marginBottom: '1rem' }}>Sign In Required</h2>
                            <p style={{ color: '#6c757d', marginBottom: '2rem' }}>
                                Sign in with your Microsoft account to access the budget tracker
                            </p>
                            <button className="btn btn-primary" style={{ fontSize: '1.1rem', padding: '1rem 2rem' }} onClick={signIn}>
                                Sign in with Microsoft
                            </button>
                            <div style={{ marginTop: '2rem' }}>
                                <button 
                                    className="btn btn-secondary" 
                                    style={{ fontSize: '0.9rem', padding: '0.5rem 1rem' }}
                                    onClick={() => {
                                        localStorage.clear();
                                        window.location.reload();
                                    }}
                                >
                                    🔄 Reset & Refresh
                                </button>
                                <p style={{ fontSize: '0.8rem', color: '#999', marginTop: '0.5rem' }}>
                                    Click if sign-in is stuck
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (isLoadingData) {
                return (
                    <div className="container">
                        <div className="header">
                            <div className="header-left">
                                <h1>DBCC Budget Tracker</h1>
                                <p>Budget monitoring and expense tracking system</p>
                            </div>
                        </div>
                        <div className="card" style={{ textAlign: 'center', padding: '3rem' }}>
                            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>📊</div>
                            <h2 style={{ marginBottom: '1rem' }}>Loading Budget Data...</h2>
                            <p style={{ color: '#6c757d' }}>
                                Fetching data from DBCC-Budget-{currentPeriod}.xlsx
                            </p>
                        </div>
                    </div>
                );
            }

            const stats = calculateStats();
            const currentMonth = new Date().getMonth();

            return (
                <div className="container">
                    <div className="header">
                        <div className="header-left">
                            <h1>DBCC Budget Tracker</h1>
                            <p>Budget monitoring and expense tracking system</p>
                        </div>
                        <div className="header-right">
                            <div className="budget-period-selector">
                                <span className="period-label">Period:</span>
                                {budgetPeriods.map(period => (
                                    <button
                                        key={period}
                                        className={`period-btn ${currentPeriod === period ? 'active' : ''}`}
                                        onClick={() => {
                                            setCurrentPeriod(period);
                                            setTimeout(() => loadBudgetFromExcel(), 100);
                                        }}
                                    >
                                        {period}
                                    </button>
                                ))}
                            </div>
                            <button className="btn btn-add-item" onClick={() => setShowAddItemModal(true)}>
                                + Add Budget Item
                            </button>
                            <button className="btn btn-secondary" onClick={openSetupNewYear}>
                                ⚙️ Setup New Year
                            </button>
                            <button className="btn btn-secondary" onClick={() => setShowReportsModal(true)}>
                                📊 Reports
                            </button>
                            <button className="btn btn-secondary" onClick={signOut}>
                                Sign Out
                            </button>
                        </div>
                    </div>

                    <div className="stats">
                        <div className="stat-card">
                            <div className="stat-label">Total Budget (FY {currentPeriod})</div>
                            <div className="stat-value">{formatCurrency(stats.totalBudget)}</div>
                            <div style={{ fontSize: '0.75rem', color: '#9ca3af', marginTop: '0.25rem' }}>
                                {currentMonth >= 3 ? 'Current year (auto-switched in April)' : 'Current year'}
                            </div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Total Spent</div>
                            <div className="stat-value">{formatCurrency(stats.totalSpent)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Remaining</div>
                            <div className="stat-value">{formatCurrency(stats.totalRemaining)}</div>
                        </div>
                    </div>

                    <div className="add-expense-section">
                        <div className="add-expense-section-left">
                            <h2>💰 Record an Expense</h2>
                            <p>Click to log a new expense against your budget</p>
                        </div>
                        <button className="btn btn-success" onClick={() => setShowExpenseModal(true)}>
                            + Add Expense
                        </button>
                    </div>

                    <div className="main-grid">
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Budget Categories</h3>
                            </div>

                            <div className="category-list">
                                {budgets.map(budget => {
                                    const percentage = (budget.spentAmount / budget.totalAmount) * 100;
                                    const remaining = budget.totalAmount - budget.spentAmount;
                                    const variance = remaining;
                                    const isExpanded = expandedCategory === budget.id;

                                    return (
                                        <div 
                                            key={budget.id} 
                                            className={`category-item ${isExpanded ? 'expanded' : ''}`}
                                            onClick={() => setExpandedCategory(isExpanded ? null : budget.id)}
                                        >
                                            <div className="category-header">
                                                <div className="category-name">
                                                    {budget.code} - {budget.name}
                                                </div>
                                                <div className="category-amount">
                                                    {formatCurrency(remaining)}
                                                </div>
                                            </div>
                                            <div className="category-progress">
                                                <div 
                                                    className={`category-progress-bar ${getProgressColor(percentage)}`}
                                                    style={{ width: `${Math.min(percentage, 100)}%` }}
                                                ></div>
                                            </div>
                                            <div className="category-stats">
                                                <span>Spent: {formatCurrency(budget.spentAmount)}</span>
                                                <span>{percentage.toFixed(1)}% used</span>
                                                <span className={variance >= 0 ? 'variance-positive' : 'variance-negative'}>
                                                    Variance: {formatCurrency(Math.abs(variance))}
                                                </span>
                                            </div>

                                            {isExpanded && budget.subCategories && budget.subCategories.length > 0 && (
                                                <div className="sub-categories" onClick={(e) => e.stopPropagation()}>
                                                    {budget.subCategories.map(subCat => {
                                                        const subPercentage = (subCat.spentAmount / subCat.totalAmount) * 100;
                                                        const subRemaining = subCat.totalAmount - subCat.spentAmount;
                                                        const isSubExpanded = expandedSubCategory === `${budget.id}-${subCat.id}`;

                                                        return (
                                                            <div 
                                                                key={subCat.id}
                                                                className={`sub-category-item ${isSubExpanded ? 'expanded' : ''}`}
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setExpandedSubCategory(isSubExpanded ? null : `${budget.id}-${subCat.id}`);
                                                                }}
                                                            >
                                                                <div className="sub-category-header">
                                                                    <div className="sub-category-name">
                                                                        {subCat.code} - {subCat.name}
                                                                    </div>
                                                                    <div className="sub-category-amount">
                                                                        {formatCurrency(subRemaining)}
                                                                    </div>
                                                                </div>
                                                                <div className="sub-category-progress">
                                                                    <div 
                                                                        className={`sub-category-progress-bar ${getProgressColor(subPercentage)}`}
                                                                        style={{ width: `${Math.min(subPercentage, 100)}%` }}
                                                                    ></div>
                                                                </div>
                                                                <div className="sub-category-stats">
                                                                    Budget: {formatCurrency(subCat.totalAmount)} • 
                                                                    Spent: {formatCurrency(subCat.spentAmount)} • 
                                                                    {subPercentage.toFixed(1)}% used
                                                                </div>

                                                                {isSubExpanded && subCat.items && subCat.items.length > 0 && (
                                                                    <div className="level3-items" onClick={(e) => e.stopPropagation()}>
                                                                        {subCat.items.map((item) => {
                                                                            const itemRemaining = item.budget - item.spent;
                                                                            const itemPercentage = (item.spent / item.budget) * 100;
                                                                            
                                                                            return (
                                                                                <div key={item.id} className="item">
                                                                                    <div className="item-header">
                                                                                        <div className="item-name">{item.name}</div>
                                                                                        <div className="item-amount">{formatCurrency(itemRemaining)}</div>
                                                                                    </div>
                                                                                    <div className="item-stats">
                                                                                        <span>Budget: {formatCurrency(item.budget)}</span>
                                                                                        <span>Spent: {formatCurrency(item.spent)}</span>
                                                                                        <span>{itemPercentage.toFixed(1)}% used</span>
                                                                                    </div>
                                                                                    {item.notes && (
                                                                                        <div className="item-notes-full">
                                                                                            <strong>Notes:</strong> {item.notes}
                                                                                        </div>
                                                                                    )}
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Recent Activity</h3>
                            </div>

                            {activities.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-icon">📝</div>
                                    <p>No expenses recorded yet</p>
                                </div>
                            ) : (
                                <div className="activity-log">
                                    {activities.map(activity => (
                                        <div key={activity.id} className="activity-item">
                                            <div className="activity-header">
                                                <span className="activity-user">{activity.userName}</span>
                                                <span className="activity-time">{formatTime(activity.timestamp)}</span>
                                            </div>
                                            <div className="activity-category">
                                                {activity.mainCategory} → {activity.subCategory}
                                            </div>
                                            <div className="activity-description">
                                                {activity.type === 'deletion' ? (
                                                    <span style={{ color: '#ef4444', fontStyle: 'italic' }}>
                                                        🗑️ Deleted: {activity.item} (by {activity.deletedBy})
                                                    </span>
                                                ) : (
                                                    activity.item
                                                )}
                                            </div>
                                            <div className="activity-amount">
                                                -{formatCurrency(activity.amount)}
                                            </div>
                                            
                                            {activity.type !== 'deletion' && (
                                                <>
                                                    <div 
                                                        className="activity-menu-trigger"
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            setOpenActivityMenu(openActivityMenu === activity.id ? null : activity.id);
                                                        }}
                                                    >
                                                        ⋮
                                                    </div>
                                                    
                                                    {openActivityMenu === activity.id && (
                                                        <div className="activity-menu">
                                                            <div 
                                                                className="activity-menu-item delete"
                                                                onClick={() => {
                                                                    handleDeleteRecord(activity.id);
                                                                    setOpenActivityMenu(null);
                                                                }}
                                                            >
                                                                🗑️ Delete
                                                            </div>
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {showExpenseModal && (
                        <div className="modal" onClick={() => setShowExpenseModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3 className="modal-title">Record Expense</h3>
                                </div>
                                <form onSubmit={handleAddExpense}>
                                    <div className="form-group">
                                        <label className="form-label">Your Name</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Enter your name"
                                            value={expenseForm.userName}
                                            onChange={(e) => setExpenseForm({...expenseForm, userName: e.target.value})}
                                            required
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Main Category (Level 1)</label>
                                        <select
                                            className="form-select"
                                            value={expenseForm.mainCategoryId || ''}
                                            onChange={(e) => {
                                                const catId = parseInt(e.target.value);
                                                const cat = budgets.find(b => b.id === catId);
                                                setExpenseForm({
                                                    ...expenseForm, 
                                                    mainCategoryId: catId,
                                                    mainCategory: cat ? `${cat.code} - ${cat.name}` : '',
                                                    subCategoryId: null,
                                                    subCategory: '',
                                                    item: ''
                                                });
                                            }}
                                            required
                                        >
                                            <option value="">Select main category</option>
                                            {budgets.map(budget => (
                                                <option key={budget.id} value={budget.id}>
                                                    {budget.code} - {budget.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {getSubCategoriesForMain().length > 0 && (
                                        <div className="form-group">
                                            <label className="form-label">Sub-Category (Level 2)</label>
                                            <select
                                                className="form-select"
                                                value={expenseForm.subCategoryId || ''}
                                                onChange={(e) => {
                                                    const subCatId = parseInt(e.target.value);
                                                    const subCat = getSubCategoriesForMain().find(s => s.id === subCatId);
                                                    setExpenseForm({
                                                        ...expenseForm, 
                                                        subCategoryId: subCatId,
                                                        subCategory: subCat ? `${subCat.code} - ${subCat.name}` : '',
                                                        item: ''
                                                    });
                                                }}
                                                required
                                            >
                                                <option value="">Select sub-category</option>
                                                {getSubCategoriesForMain().map(subCat => (
                                                    <option key={subCat.id} value={subCat.id}>
                                                        {subCat.code} - {subCat.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}

                                    {getItemsForSubCategory().length > 0 && (
                                        <div className="form-group">
                                            <label className="form-label">Specific Item (Level 3)</label>
                                            <select
                                                className="form-select"
                                                value={expenseForm.item}
                                                onChange={(e) => setExpenseForm({...expenseForm, item: e.target.value})}
                                                required
                                            >
                                                <option value="">Select specific item</option>
                                                {getItemsForSubCategory().map((item) => (
                                                    <option key={item.id} value={item.name}>
                                                        {item.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label className="form-label">Description</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="What was this expense for?"
                                            value={expenseForm.description}
                                            onChange={(e) => setExpenseForm({...expenseForm, description: e.target.value})}
                                            required
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Amount (Pula)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            className="form-input"
                                            placeholder="0.00"
                                            value={expenseForm.amount}
                                            onChange={(e) => setExpenseForm({...expenseForm, amount: e.target.value})}
                                            required
                                        />
                                    </div>

                                    <div className="modal-actions">
                                        <button 
                                            type="button" 
                                            className="btn btn-secondary" 
                                            onClick={() => setShowExpenseModal(false)}
                                        >
                                            Cancel
                                        </button>
                                        <button 
                                            type="submit" 
                                            className="btn btn-primary"
                                            disabled={!expenseForm.mainCategoryId || !expenseForm.subCategoryId || (getItemsForSubCategory().length > 0 && !expenseForm.item)}
                                        >
                                            Record Expense
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showSetupModal && (
                        <div className="modal" onClick={() => setShowSetupModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '800px', maxHeight: '90vh' }}>
                                <div className="modal-header">
                                    <h3 className="modal-title">Setup New Fiscal Year</h3>
                                </div>
                                
                                <div className="form-group">
                                    <label className="form-label">New Fiscal Year</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        placeholder="e.g., 2025-26"
                                        value={newFiscalYear}
                                        onChange={(e) => setNewFiscalYear(e.target.value)}
                                    />
                                </div>

                                <p style={{ color: '#6c757d', marginBottom: '1rem', fontSize: '0.9rem' }}>
                                    Below is your current budget structure. You can edit amounts, delete items, or add new ones. 
                                    Click "Create New Year" when ready.
                                </p>

                                <div style={{ background: '#eff6ff', padding: '0.75rem', borderRadius: '6px', marginBottom: '1rem', fontSize: '0.85rem', color: '#1e40af', border: '1px solid #bfdbfe' }}>
                                    💡 <strong>Tip:</strong> You can also use "Setup New Year" to edit the current year ({currentPeriod}) budget. 
                                    Just set the fiscal year to {currentPeriod} and make your changes.
                                </div>

                                <div style={{ maxHeight: '400px', overflowY: 'auto', border: '1px solid #e9ecef', borderRadius: '8px', padding: '1rem' }}>
                                    {setupYearData.map((mainCat) => (
                                        <div key={mainCat.id} style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f8f9fa', borderRadius: '8px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem' }}>
                                                <strong style={{ color: '#1e40af' }}>{mainCat.code} - {mainCat.name}</strong>
                                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                                    <input
                                                        type="number"
                                                        value={mainCat.totalAmount}
                                                        onChange={(e) => updateSetupBudgetAmount(mainCat.id, null, null, e.target.value)}
                                                        className="setup-budget-input"
                                                    />
                                                    <button
                                                        onClick={() => deleteSetupItem(mainCat.id, null, null)}
                                                        className="setup-delete-btn"
                                                    >
                                                        🗑️
                                                    </button>
                                                </div>
                                            </div>

                                            {mainCat.subCategories && mainCat.subCategories.map((subCat) => (
                                                <div key={subCat.id} style={{ marginLeft: '1rem', marginBottom: '1rem', padding: '0.75rem', background: 'white', borderRadius: '6px' }}>
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>
                                                        <span style={{ fontWeight: '600', fontSize: '0.95rem' }}>{subCat.code} - {subCat.name}</span>
                                                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                                            <input
                                                                type="number"
                                                                value={subCat.totalAmount}
                                                                onChange={(e) => updateSetupBudgetAmount(mainCat.id, subCat.id, null, e.target.value)}
                                                                style={{ width: '130px', padding: '0.4rem', border: '1px solid #e9ecef', borderRadius: '4px', fontSize: '0.9rem' }}
                                                            />
                                                            <button
                                                                onClick={() => deleteSetupItem(mainCat.id, subCat.id, null)}
                                                                style={{ padding: '0.4rem 0.6rem', background: '#fff', border: '1px solid #ef4444', color: '#ef4444', borderRadius: '4px', cursor: 'pointer', fontSize: '0.85rem' }}
                                                            >
                                                                🗑️
                                                            </button>
                                                        </div>
                                                    </div>

                                                    {subCat.items && subCat.items.map((item) => (
                                                        <div key={item.id} style={{ marginLeft: '1rem', marginTop: '0.5rem', padding: '0.5rem', background: '#f8f9fa', borderRadius: '4px', fontSize: '0.9rem' }}>
                                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                                <span style={{ flex: 1 }}>{item.name}</span>
                                                                <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center' }}>
                                                                    <input
                                                                        type="number"
                                                                        value={item.budget}
                                                                        onChange={(e) => updateSetupBudgetAmount(mainCat.id, subCat.id, item.id, e.target.value)}
                                                                        style={{ width: '110px', padding: '0.3rem', border: '1px solid #e9ecef', borderRadius: '4px', fontSize: '0.85rem' }}
                                                                    />
                                                                    <button
                                                                        onClick={() => deleteSetupItem(mainCat.id, subCat.id, item.id)}
                                                                        style={{ padding: '0.3rem 0.5rem', background: '#fff', border: '1px solid #ef4444', color: '#ef4444', borderRadius: '4px', cursor: 'pointer', fontSize: '0.8rem' }}
                                                                    >
                                                                        🗑️
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            {item.notes && (
                                                                <div style={{ marginTop: '0.25rem', fontSize: '0.8rem', color: '#6c757d', fontStyle: 'italic' }}>
                                                                    Note: {item.notes}
                                                                </div>
                                                            )}
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    ))}
                                </div>

                                <div className="modal-actions" style={{ marginTop: '1.5rem' }}>
                                    <button 
                                        type="button" 
                                        className="btn btn-secondary" 
                                        onClick={() => setShowSetupModal(false)}
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        type="button" 
                                        className="btn btn-primary"
                                        onClick={handleSetupYearSubmit}
                                    >
                                        Create New Year Budget
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddItemModal && (
                        <div className="modal" onClick={() => setShowAddItemModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3 className="modal-title">Add Budget Item</h3>
                                </div>
                                <form onSubmit={handleAddBudgetItem}>
                                    <div className="form-group">
                                        <label className="form-label">Item Level</label>
                                        <select
                                            className="form-select"
                                            value={addItemForm.level}
                                            onChange={(e) => setAddItemForm({...addItemForm, level: e.target.value, mainCategoryId: null, subCategoryId: null})}
                                            required
                                        >
                                            <option value="1">Level 1 - Main Category (e.g., A16)</option>
                                            <option value="2">Level 2 - Sub-Category (e.g., 3150)</option>
                                            <option value="3">Level 3 - Individual Item</option>
                                        </select>
                                    </div>

                                    {(addItemForm.level === '2' || addItemForm.level === '3') && (
                                        <div className="form-group">
                                            <label className="form-label">Parent Main Category</label>
                                            <select
                                                className="form-select"
                                                value={addItemForm.mainCategoryId || ''}
                                                onChange={(e) => setAddItemForm({...addItemForm, mainCategoryId: parseInt(e.target.value), subCategoryId: null})}
                                                required
                                            >
                                                <option value="">Select main category</option>
                                                {budgets.map(budget => (
                                                    <option key={budget.id} value={budget.id}>
                                                        {budget.code} - {budget.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}

                                    {addItemForm.level === '3' && addItemForm.mainCategoryId && (
                                        <div className="form-group">
                                            <label className="form-label">Parent Sub-Category</label>
                                            <select
                                                className="form-select"
                                                value={addItemForm.subCategoryId || ''}
                                                onChange={(e) => setAddItemForm({...addItemForm, subCategoryId: parseInt(e.target.value)})}
                                                required
                                            >
                                                <option value="">Select sub-category</option>
                                                {budgets.find(b => b.id === addItemForm.mainCategoryId)?.subCategories.map(subCat => (
                                                    <option key={subCat.id} value={subCat.id}>
                                                        {subCat.code} - {subCat.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}

                                    <div className="form-group">
                                        <label className="form-label">Code {addItemForm.level === '3' ? '(optional)' : '(required)'}</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder={addItemForm.level === '1' ? 'e.g., A17' : addItemForm.level === '2' ? 'e.g., 3180' : 'Leave blank for Level 3'}
                                            value={addItemForm.code}
                                            onChange={(e) => setAddItemForm({...addItemForm, code: e.target.value})}
                                            required={addItemForm.level !== '3'}
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Name</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Enter item name"
                                            value={addItemForm.name}
                                            onChange={(e) => setAddItemForm({...addItemForm, name: e.target.value})}
                                            required
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Budget Amount (Pula)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            className="form-input"
                                            placeholder="0.00"
                                            value={addItemForm.budget}
                                            onChange={(e) => setAddItemForm({...addItemForm, budget: e.target.value})}
                                            required
                                        />
                                    </div>

                                    <div className="form-group">
                                        <label className="form-label">Notes (optional)</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Add any relevant notes"
                                            value={addItemForm.notes}
                                            onChange={(e) => setAddItemForm({...addItemForm, notes: e.target.value})}
                                        />
                                    </div>

                                    <div className="modal-actions">
                                        <button 
                                            type="button" 
                                            className="btn btn-secondary" 
                                            onClick={() => setShowAddItemModal(false)}
                                        >
                                            Cancel
                                        </button>
                                        <button type="submit" className="btn btn-primary">
                                            Add Budget Item
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {showReportsModal && (
                        <div className="modal" onClick={() => setShowReportsModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                                <div className="modal-header">
                                    <h3 className="modal-title">Generate Reports</h3>
                                </div>
                                
                                <p style={{ color: '#6c757d', marginBottom: '2rem', fontSize: '0.95rem' }}>
                                    Select a quarter to generate a comprehensive budget report with detailed breakdowns and activity log.
                                </p>

                                <div style={{ display: 'grid', gap: '1rem' }}>
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => {
                                            generateQuarterlyReport('Q1');
                                            setShowReportsModal(false);
                                        }}
                                        style={{ fontSize: '1rem', padding: '1rem' }}
                                    >
                                        📊 Q1 Report (Apr-Jun)
                                    </button>
                                    
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => {
                                            generateQuarterlyReport('Q2');
                                            setShowReportsModal(false);
                                        }}
                                        style={{ fontSize: '1rem', padding: '1rem' }}
                                    >
                                        📊 Q2 Report (Jul-Sep)
                                    </button>
                                    
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => {
                                            generateQuarterlyReport('Q3');
                                            setShowReportsModal(false);
                                        }}
                                        style={{ fontSize: '1rem', padding: '1rem' }}
                                    >
                                        📊 Q3 Report (Oct-Dec)
                                    </button>
                                    
                                    <button 
                                        className="btn btn-primary"
                                        onClick={() => {
                                            generateQuarterlyReport('Q4');
                                            setShowReportsModal(false);
                                        }}
                                        style={{ fontSize: '1rem', padding: '1rem' }}
                                    >
                                        📊 Q4 Report (Jan-Mar)
                                    </button>

                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            generateQuarterlyReport('Annual');
                                            setShowReportsModal(false);
                                        }}
                                        style={{ fontSize: '1rem', padding: '1rem' }}
                                    >
                                        📈 Annual Report
                                    </button>
                                </div>

                                <div className="modal-actions" style={{ marginTop: '2rem' }}>
                                    <button 
                                        type="button" 
                                        className="btn btn-secondary" 
                                        onClick={() => setShowReportsModal(false)}
                                        style={{ width: '100%' }}
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {notification && (
                        <div className="notification">
                            {notification}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<BudgetTrackerApp />, document.getElementById('root'));
    </script>
</body>
</html>
