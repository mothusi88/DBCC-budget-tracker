<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBCC Budget Tracker</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #212529;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
        }

        .header-left h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 0.25rem;
        }

        .header-left p {
            color: #6c757d;
            font-size: 0.95rem;
        }

        .header-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #1e40af;
            color: white;
        }

        .btn-primary:hover {
            background: #1e3a8a;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #495057;
            border: 2px solid #dee2e6;
        }

        .btn-secondary:hover {
            border-color: #1e40af;
            color: #1e40af;
        }

        .btn-success {
            background: #10b981;
            color: white;
            font-size: 1.1rem;
            padding: 1rem 2rem;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-large {
            font-size: 1.1rem;
            padding: 1.25rem 2.5rem;
        }

        /* Stats Cards */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .stat-label {
            font-size: 0.85rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e40af;
        }

        /* Main Content Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Categories Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #212529;
        }

        /* Budget Categories */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .category-item {
            padding: 1.25rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-item:hover {
            border-color: #1e40af;
            background: #f8f9ff;
        }

        .category-item.expanded {
            background: #f8f9ff;
            border-color: #1e40af;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: 600;
            font-size: 1.05rem;
            color: #212529;
        }

        .category-amount {
            font-weight: 700;
            font-size: 1.15rem;
            color: #1e40af;
        }

        .category-progress {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 0.75rem 0;
            overflow: hidden;
        }

        .category-progress-bar {
            height: 100%;
            background: #1e40af;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .category-progress-bar.warning { background: #f59e0b; }
        .category-progress-bar.danger { background: #ef4444; }

        .category-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.5rem;
        }

        .variance-positive { color: #10b981; font-weight: 600; }
        .variance-negative { color: #ef4444; font-weight: 600; }

        /* Sub-items */
        .sub-items {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
        }

        .sub-item {
            padding: 0.75rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .sub-item-name {
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .sub-item-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        /* Activity Log */
        .activity-log {
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 1rem;
            border-left: 3px solid #1e40af;
            background: #f8f9ff;
            border-radius: 6px;
            margin-bottom: 0.75rem;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .activity-user {
            font-weight: 600;
            color: #1e40af;
        }

        .activity-time {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .activity-description {
            font-size: 0.95rem;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .activity-amount {
            font-weight: 700;
            color: #ef4444;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #212529;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #1e40af;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* Add Expense Section - PROMINENT */
        .add-expense-section {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(30, 64, 175, 0.3);
        }

        .add-expense-section h2 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .add-expense-section p {
            color: rgba(255,255,255,0.9);
            margin-bottom: 1.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const MSAL_CONFIG = {
            auth: {
                clientId: '642e1f35-d45f-47d7-97fd-bb6bf64ff6e5',
                authority: 'https://login.microsoftonline.com/common',
                redirectUri: window.location.origin + window.location.pathname
            },
            cache: { cacheLocation: 'localStorage' }
        };

        const EXCEL_FILE_PATH = '/Budget-Tracker-Template.xlsx';

        function BudgetTrackerApp() {
            const [isSignedIn, setIsSignedIn] = useState(false);
            const [msalInstance, setMsalInstance] = useState(null);
            const [accessToken, setAccessToken] = useState(null);
            const [budgets, setBudgets] = useState([]);
            const [activities, setActivities] = useState([]);
            const [expandedCategory, setExpandedCategory] = useState(null);
            const [showExpenseModal, setShowExpenseModal] = useState(false);
            const [showSetupModal, setShowSetupModal] = useState(false);
            const [notification, setNotification] = useState(null);
            const [loading, setLoading] = useState(false);
            const [fileId, setFileId] = useState(null);

            const [expenseForm, setExpenseForm] = useState({
                category: '',
                subCategory: '',
                description: '',
                amount: '',
                userName: ''
            });

            useEffect(() => {
                initializeMsal();
            }, []);

            const initializeMsal = async () => {
                const msalInstance = new window.msal.PublicClientApplication(MSAL_CONFIG);
                await msalInstance.initialize();
                setMsalInstance(msalInstance);

                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    setIsSignedIn(true);
                    await getAccessToken(msalInstance, accounts[0]);
                }
            };

            const signIn = async () => {
                try {
                    const response = await msalInstance.loginPopup({
                        scopes: ['Files.ReadWrite', 'User.Read']
                    });
                    setIsSignedIn(true);
                    await getAccessToken(msalInstance, response.account);
                } catch (error) {
                    alert('Sign-in failed: ' + error.message);
                }
            };

            const getAccessToken = async (msal, account) => {
                try {
                    const response = await msal.acquireTokenSilent({
                        scopes: ['Files.ReadWrite'],
                        account: account
                    });
                    setAccessToken(response.accessToken);
                    await findExcelFile(response.accessToken);
                } catch (error) {
                    alert('Failed to get access token');
                }
            };

            const findExcelFile = async (token) => {
                // Simplified - in real implementation would find and load Excel file
                // For now, load sample data
                loadSampleData();
            };

            const loadSampleData = () => {
                setBudgets([
                    {
                        id: 1,
                        code: 'A14',
                        name: 'Staff Costs - Indirect',
                        totalAmount: 3297995,
                        spentAmount: 80785,
                        subItems: [
                            { id: 1, code: '2127', name: 'BOCRA Social Activities', budget: 150000, spent: 80785 },
                            { id: 2, code: '2128', name: 'Staff uniform', budget: 1684537, spent: 0 },
                            { id: 3, code: '2132', name: 'Subscriptions to professional memberships', budget: 13308, spent: 3200 }
                        ]
                    },
                    {
                        id: 2,
                        code: 'A15',
                        name: 'Training',
                        totalAmount: 469189,
                        spentAmount: 124318.59,
                        subItems: [
                            { id: 1, name: 'Planning & Managing PR Campaigns', budget: 102478.71, spent: 0 },
                            { id: 2, name: 'Certificate in Corporate Communication', budget: 32232.51, spent: 51696.23 },
                            { id: 3, name: 'Public Relations and Media Skills Course', budget: 20710.01, spent: 0 },
                            { id: 4, name: 'Content regulation Broadcasting', budget: 98103.71, spent: 72622.36 }
                        ]
                    },
                    {
                        id: 3,
                        code: 'A16',
                        name: 'Operating costs',
                        totalAmount: 16160398,
                        spentAmount: 1185701.66,
                        subItems: [
                            { id: 1, code: '2134', name: 'Entertainment', budget: 20000, spent: 0 },
                            { id: 2, code: '3150', name: 'Consultancies', budget: 4604133, spent: 689527.94 }
                        ]
                    }
                ]);

                setActivities([
                    {
                        id: 1,
                        timestamp: new Date().toISOString(),
                        userName: 'Keotshepile M.',
                        category: 'Training',
                        description: 'Certificate in Corporate Communication',
                        amount: 51696.23
                    },
                    {
                        id: 2,
                        timestamp: new Date(Date.now() - 86400000).toISOString(),
                        userName: 'Mothusi M.',
                        category: 'Operating costs',
                        description: 'Consumer/operator Perception Survey',
                        amount: 444708.30
                    }
                ]);
            };

            const formatCurrency = (amount) => {
                return `P ${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatTime = (timestamp) => {
                const date = new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours}h ago`;
                return date.toLocaleDateString();
            };

            const calculateStats = () => {
                const totalBudget = budgets.reduce((sum, b) => sum + b.totalAmount, 0);
                const totalSpent = budgets.reduce((sum, b) => sum + b.spentAmount, 0);
                const totalRemaining = totalBudget - totalSpent;
                return { totalBudget, totalSpent, totalRemaining };
            };

            const getProgressColor = (percentage) => {
                if (percentage >= 90) return 'danger';
                if (percentage >= 75) return 'warning';
                return '';
            };

            const handleAddExpense = (e) => {
                e.preventDefault();
                alert('Expense would be recorded to OneDrive Excel here');
                setShowExpenseModal(false);
            };

            if (!isSignedIn) {
                return (
                    <div className="container">
                        <div className="header">
                            <div className="header-left">
                                <h1>DBCC Budget Tracker</h1>
                                <p>Budget monitoring and expense tracking system</p>
                            </div>
                        </div>
                        <div className="card" style={{ textAlign: 'center', padding: '3rem' }}>
                            <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>üîê</div>
                            <h2 style={{ marginBottom: '1rem' }}>Sign In Required</h2>
                            <p style={{ color: '#6c757d', marginBottom: '2rem' }}>
                                Sign in with your Microsoft account to access the budget tracker
                            </p>
                            <button className="btn btn-primary btn-large" onClick={signIn}>
                                Sign in with Microsoft
                            </button>
                        </div>
                    </div>
                );
            }

            const stats = calculateStats();

            return (
                <div className="container">
                    <div className="header">
                        <div className="header-left">
                            <h1>DBCC Budget Tracker</h1>
                            <p>Budget monitoring and expense tracking system</p>
                        </div>
                        <div className="header-right">
                            <button className="btn btn-secondary" onClick={() => setShowSetupModal(true)}>
                                ‚öôÔ∏è Setup New Year
                            </button>
                            <button className="btn btn-secondary">
                                üìä Reports
                            </button>
                        </div>
                    </div>

                    <div className="stats">
                        <div className="stat-card">
                            <div className="stat-label">Total Budget</div>
                            <div className="stat-value">{formatCurrency(stats.totalBudget)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Total Spent</div>
                            <div className="stat-value">{formatCurrency(stats.totalSpent)}</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-label">Remaining</div>
                            <div className="stat-value">{formatCurrency(stats.totalRemaining)}</div>
                        </div>
                    </div>

                    <div className="add-expense-section">
                        <h2>üí∞ Record an Expense</h2>
                        <p>Click below to log a new expense against your budget</p>
                        <button className="btn btn-success btn-large" onClick={() => setShowExpenseModal(true)}>
                            + Add Expense
                        </button>
                    </div>

                    <div className="main-grid">
                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Budget Categories</h3>
                            </div>

                            <div className="category-list">
                                {budgets.map(budget => {
                                    const percentage = (budget.spentAmount / budget.totalAmount) * 100;
                                    const remaining = budget.totalAmount - budget.spentAmount;
                                    const variance = remaining;
                                    const isExpanded = expandedCategory === budget.id;

                                    return (
                                        <div 
                                            key={budget.id} 
                                            className={`category-item ${isExpanded ? 'expanded' : ''}`}
                                            onClick={() => setExpandedCategory(isExpanded ? null : budget.id)}
                                        >
                                            <div className="category-header">
                                                <div className="category-name">
                                                    {budget.code} - {budget.name}
                                                </div>
                                                <div className="category-amount">
                                                    {formatCurrency(remaining)}
                                                </div>
                                            </div>
                                            <div className="category-progress">
                                                <div 
                                                    className={`category-progress-bar ${getProgressColor(percentage)}`}
                                                    style={{ width: `${Math.min(percentage, 100)}%` }}
                                                ></div>
                                            </div>
                                            <div className="category-stats">
                                                <span>Spent: {formatCurrency(budget.spentAmount)}</span>
                                                <span>{percentage.toFixed(1)}% used</span>
                                                <span className={variance >= 0 ? 'variance-positive' : 'variance-negative'}>
                                                    Variance: {formatCurrency(Math.abs(variance))}
                                                </span>
                                            </div>

                                            {isExpanded && budget.subItems && (
                                                <div className="sub-items" onClick={(e) => e.stopPropagation()}>
                                                    {budget.subItems.map(sub => (
                                                        <div key={sub.id} className="sub-item">
                                                            <div className="sub-item-name">
                                                                {sub.code && `${sub.code} - `}{sub.name}
                                                            </div>
                                                            <div className="sub-item-stats">
                                                                <span>Budget: {formatCurrency(sub.budget)}</span>
                                                                <span>Spent: {formatCurrency(sub.spent)}</span>
                                                                <span>Remaining: {formatCurrency(sub.budget - sub.spent)}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="card">
                            <div className="card-header">
                                <h3 className="card-title">Recent Activity</h3>
                            </div>

                            {activities.length === 0 ? (
                                <div className="empty-state">
                                    <div className="empty-state-icon">üìù</div>
                                    <p>No expenses recorded yet</p>
                                </div>
                            ) : (
                                <div className="activity-log">
                                    {activities.map(activity => (
                                        <div key={activity.id} className="activity-item">
                                            <div className="activity-header">
                                                <span className="activity-user">{activity.userName}</span>
                                                <span className="activity-time">{formatTime(activity.timestamp)}</span>
                                            </div>
                                            <div className="activity-description">
                                                {activity.description} ‚Ä¢ {activity.category}
                                            </div>
                                            <div className="activity-amount">
                                                -{formatCurrency(activity.amount)}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {showExpenseModal && (
                        <div className="modal" onClick={() => setShowExpenseModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    <h3 className="modal-title">Record Expense</h3>
                                </div>
                                <form onSubmit={handleAddExpense}>
                                    <div className="form-group">
                                        <label className="form-label">Your Name</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Enter your name"
                                            value={expenseForm.userName}
                                            onChange={(e) => setExpenseForm({...expenseForm, userName: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Main Category</label>
                                        <select
                                            className="form-select"
                                            value={expenseForm.category}
                                            onChange={(e) => setExpenseForm({...expenseForm, category: e.target.value})}
                                            required
                                        >
                                            <option value="">Select category</option>
                                            {budgets.map(budget => (
                                                <option key={budget.id} value={budget.name}>
                                                    {budget.code} - {budget.name}
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Sub-Category (Optional)</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="Enter sub-category if applicable"
                                            value={expenseForm.subCategory}
                                            onChange={(e) => setExpenseForm({...expenseForm, subCategory: e.target.value})}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Description</label>
                                        <input
                                            type="text"
                                            className="form-input"
                                            placeholder="What was this expense for?"
                                            value={expenseForm.description}
                                            onChange={(e) => setExpenseForm({...expenseForm, description: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Amount (Pula)</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            className="form-input"
                                            placeholder="0.00"
                                            value={expenseForm.amount}
                                            onChange={(e) => setExpenseForm({...expenseForm, amount: e.target.value})}
                                            required
                                        />
                                    </div>
                                    <div className="modal-actions">
                                        <button type="button" className="btn btn-secondary" onClick={() => setShowExpenseModal(false)}>
                                            Cancel
                                        </button>
                                        <button type="submit" className="btn btn-primary">
                                            Record Expense
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<BudgetTrackerApp />, document.getElementById('root'));
    </script>
</body>
</html>
